<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      data-namespace-typo3-fluid="true"
>

    <f:variable name="categories" value="{gadgetoGoogle:groupByCategory(items: locations)}" />
    <f:render section="RootLevel"
              arguments="{categories: categories, data: data, settings: settings, 
                                      settingsForLayout: settingsForLayout}" />
    
    <!-- ======================================================== -->

    <f:section name="RootLevel">
        <f:variable name="level" value="{level + 1}" />
        <f:variable name="sortedCategories" value="{gadgetoGoogle:sortGroupedCategories(items: categories)}" />

        <f:for each="{sortedCategories}" as="category">
            <f:if condition="{category.children}">
                <f:render section="SubLevel"
                          arguments="{categories: category.children, parent: category, level: level, data: data, 
                                  settings: settings, settingsForLayout: settingsForLayout}" />
            </f:if>
        </f:for>
    </f:section>

    <!-- ======================================================== -->

    <f:section name="SubLevel">
        <f:variable name="level" value="{level + 1}" />
        <f:variable name="sortedCategories" value="{gadgetoGoogle:sortGroupedCategories(items: categories)}" />

        <ul class="category-list level-{level}">
            <f:for each="{sortedCategories}" as="category">
                <li class="category-item level-{level}">

                    <h3>{category.object.title}</h3>

                    <f:if condition="{category.locations}">
                        <ul class="location-list">
                            <f:for each="{gadgetoGoogle:sortLocations(items:category.locations)}" as="location">
                                <f:render partial="Location/Item"
                                          section="CategoryList"
                                          arguments="{location: location, data: data, settings: settings, 
                                                 settingsForLayout: settingsForLayout}" />
                            </f:for>
                        </ul>
                    </f:if>

                    <f:if condition="{category.children}">
                        <f:render section="SubLevel"
                                  arguments="{categories: category.children, parent: category, level: level, data: data, 
                                          settings: settings, settingsForLayout: settingsForLayout}" />
                    </f:if>
                </li>
            </f:for>
        </ul>
    </f:section>
</html>